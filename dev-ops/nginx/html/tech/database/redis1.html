<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/tech/database/redis1.html"><meta property="og:site_name" content="txy"><meta property="og:title" content="Redis(上)"><meta property="og:description" content="·为什么用redis ·数据结构 struct sdshdr { int len;// 记录已使用的长度 int free; // 记录空闲未使用的长度 char[] buf; // 字符数组 }"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-05T10:16:42.000Z"><meta property="article:tag" content="数据类型"><meta property="article:tag" content="AOF&RDB"><meta property="article:tag" content="缓存一致性"><meta property="article:tag" content="redis实战"><meta property="article:published_time" content="2023-02-12T00:00:00.000Z"><meta property="article:modified_time" content="2025-02-05T10:16:42.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redis(上)","image":[""],"datePublished":"2023-02-12T00:00:00.000Z","dateModified":"2025-02-05T10:16:42.000Z","author":[]}</script><title>Redis(上) | txy</title><meta name="description" content="·为什么用redis ·数据结构 struct sdshdr { int len;// 记录已使用的长度 int free; // 记录空闲未使用的长度 char[] buf; // 字符数组 }">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-c9869e9f.css" as="style"><link rel="stylesheet" href="/assets/style-c9869e9f.css">
    <link rel="modulepreload" href="/assets/app-76848ba1.js"><link rel="modulepreload" href="/assets/redis1.html-da7ec85e.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/redis1.html-2a9fb12f.js"><link rel="prefetch" href="/assets/index.html-735676f8.js" as="script"><link rel="prefetch" href="/assets/slides.html-4fecdfc5.js" as="script"><link rel="prefetch" href="/assets/index.html-b73bbdd6.js" as="script"><link rel="prefetch" href="/assets/newyear.html-0b95f067.js" as="script"><link rel="prefetch" href="/assets/index.html-2e696d81.js" as="script"><link rel="prefetch" href="/assets/index.html-9ba67c24.js" as="script"><link rel="prefetch" href="/assets/day01.html-699a8bed.js" as="script"><link rel="prefetch" href="/assets/index.html-83dc8332.js" as="script"><link rel="prefetch" href="/assets/day01.html-71cb9b95.js" as="script"><link rel="prefetch" href="/assets/day02.html-eded512f.js" as="script"><link rel="prefetch" href="/assets/day03.html-84f6dff3.js" as="script"><link rel="prefetch" href="/assets/day04.html-9a6869e1.js" as="script"><link rel="prefetch" href="/assets/day05.html-0e6c5a2c.js" as="script"><link rel="prefetch" href="/assets/day06.html-31c368d4.js" as="script"><link rel="prefetch" href="/assets/day07~day08.html-b7e430b5.js" as="script"><link rel="prefetch" href="/assets/day09~day10.html-2779454b.js" as="script"><link rel="prefetch" href="/assets/day11.html-822f418f.js" as="script"><link rel="prefetch" href="/assets/day12.html-7cf65a1c.js" as="script"><link rel="prefetch" href="/assets/index.html-44520044.js" as="script"><link rel="prefetch" href="/assets/network.html-482c2066.js" as="script"><link rel="prefetch" href="/assets/os.html-da15e7b0.js" as="script"><link rel="prefetch" href="/assets/index.html-0aeb6daa.js" as="script"><link rel="prefetch" href="/assets/index.html-f9510b89.js" as="script"><link rel="prefetch" href="/assets/index.html-81d90874.js" as="script"><link rel="prefetch" href="/assets/mysql.html-84394db1.js" as="script"><link rel="prefetch" href="/assets/redis2.html-cbf72563.js" as="script"><link rel="prefetch" href="/assets/index.html-dc1e2af1.js" as="script"><link rel="prefetch" href="/assets/javaBasic.html-a53741d0.js" as="script"><link rel="prefetch" href="/assets/juc.html-2ed54481.js" as="script"><link rel="prefetch" href="/assets/jvm.html-bef0e71c.js" as="script"><link rel="prefetch" href="/assets/logframework.html-c507b781.js" as="script"><link rel="prefetch" href="/assets/index.html-1204568e.js" as="script"><link rel="prefetch" href="/assets/404.html-b4776d74.js" as="script"><link rel="prefetch" href="/assets/index.html-74e26e5f.js" as="script"><link rel="prefetch" href="/assets/index.html-fc2f755f.js" as="script"><link rel="prefetch" href="/assets/index.html-3ab584ef.js" as="script"><link rel="prefetch" href="/assets/index.html-85a9d1a5.js" as="script"><link rel="prefetch" href="/assets/index.html-6e464e0f.js" as="script"><link rel="prefetch" href="/assets/index.html-790dcb3a.js" as="script"><link rel="prefetch" href="/assets/index.html-d9317e05.js" as="script"><link rel="prefetch" href="/assets/index.html-f632a12d.js" as="script"><link rel="prefetch" href="/assets/index.html-58b086d3.js" as="script"><link rel="prefetch" href="/assets/index.html-29d51dba.js" as="script"><link rel="prefetch" href="/assets/index.html-3fce8ebd.js" as="script"><link rel="prefetch" href="/assets/index.html-4fa67ef4.js" as="script"><link rel="prefetch" href="/assets/index.html-a345065e.js" as="script"><link rel="prefetch" href="/assets/index.html-99676ec6.js" as="script"><link rel="prefetch" href="/assets/index.html-962f5db5.js" as="script"><link rel="prefetch" href="/assets/index.html-f032921f.js" as="script"><link rel="prefetch" href="/assets/index.html-59885d4a.js" as="script"><link rel="prefetch" href="/assets/index.html-db45e329.js" as="script"><link rel="prefetch" href="/assets/index.html-bd7cd013.js" as="script"><link rel="prefetch" href="/assets/index.html-e5107a9e.js" as="script"><link rel="prefetch" href="/assets/index.html-833a67e5.js" as="script"><link rel="prefetch" href="/assets/index.html-3ca41c9b.js" as="script"><link rel="prefetch" href="/assets/index.html-55f4ecb4.js" as="script"><link rel="prefetch" href="/assets/index.html-51ea9059.js" as="script"><link rel="prefetch" href="/assets/index.html-b861f507.js" as="script"><link rel="prefetch" href="/assets/index.html-9cf4f270.js" as="script"><link rel="prefetch" href="/assets/index.html-4de94123.js" as="script"><link rel="prefetch" href="/assets/index.html-1e835183.js" as="script"><link rel="prefetch" href="/assets/index.html-9b6d9a9f.js" as="script"><link rel="prefetch" href="/assets/index.html-a12bc44e.js" as="script"><link rel="prefetch" href="/assets/index.html-345340b0.js" as="script"><link rel="prefetch" href="/assets/index.html-2f0298d3.js" as="script"><link rel="prefetch" href="/assets/index.html-60dd4134.js" as="script"><link rel="prefetch" href="/assets/index.html-1c2d577e.js" as="script"><link rel="prefetch" href="/assets/index.html-5c157547.js" as="script"><link rel="prefetch" href="/assets/index.html-a3cb0e86.js" as="script"><link rel="prefetch" href="/assets/index.html-9a206450.js" as="script"><link rel="prefetch" href="/assets/index.html-51455f85.js" as="script"><link rel="prefetch" href="/assets/index.html-e6e37831.js" as="script"><link rel="prefetch" href="/assets/index.html-d9ccb502.js" as="script"><link rel="prefetch" href="/assets/index.html-6fd80673.js" as="script"><link rel="prefetch" href="/assets/index.html-554d1e33.js" as="script"><link rel="prefetch" href="/assets/index.html-25073f64.js" as="script"><link rel="prefetch" href="/assets/index.html-bf1c749e.js" as="script"><link rel="prefetch" href="/assets/index.html-ed3627f5.js" as="script"><link rel="prefetch" href="/assets/index.html-20d8fb9b.js" as="script"><link rel="prefetch" href="/assets/index.html-a40f67a3.js" as="script"><link rel="prefetch" href="/assets/index.html-90976564.js" as="script"><link rel="prefetch" href="/assets/index.html-9a23dc1f.js" as="script"><link rel="prefetch" href="/assets/index.html-64e27dec.js" as="script"><link rel="prefetch" href="/assets/index.html-5789d2a3.js" as="script"><link rel="prefetch" href="/assets/index.html-47621742.js" as="script"><link rel="prefetch" href="/assets/index.html-5da90325.js" as="script"><link rel="prefetch" href="/assets/index.html-5128b590.js" as="script"><link rel="prefetch" href="/assets/index.html-75ba5bac.js" as="script"><link rel="prefetch" href="/assets/index.html-5d8b535e.js" as="script"><link rel="prefetch" href="/assets/slides.html-608b6cbe.js" as="script"><link rel="prefetch" href="/assets/index.html-1cae5a7a.js" as="script"><link rel="prefetch" href="/assets/newyear.html-cd4833e6.js" as="script"><link rel="prefetch" href="/assets/index.html-c3f30bd9.js" as="script"><link rel="prefetch" href="/assets/index.html-31c72eb5.js" as="script"><link rel="prefetch" href="/assets/day01.html-4234f424.js" as="script"><link rel="prefetch" href="/assets/index.html-0a425f4b.js" as="script"><link rel="prefetch" href="/assets/day01.html-643bf01f.js" as="script"><link rel="prefetch" href="/assets/day02.html-79287855.js" as="script"><link rel="prefetch" href="/assets/day03.html-c9903c65.js" as="script"><link rel="prefetch" href="/assets/day04.html-2fbdc377.js" as="script"><link rel="prefetch" href="/assets/day05.html-17cd4811.js" as="script"><link rel="prefetch" href="/assets/day06.html-51fa191f.js" as="script"><link rel="prefetch" href="/assets/day07~day08.html-cb03c12c.js" as="script"><link rel="prefetch" href="/assets/day09~day10.html-8916dedb.js" as="script"><link rel="prefetch" href="/assets/day11.html-c6779ac3.js" as="script"><link rel="prefetch" href="/assets/day12.html-64bea0a4.js" as="script"><link rel="prefetch" href="/assets/index.html-6ed497fc.js" as="script"><link rel="prefetch" href="/assets/network.html-db4623fb.js" as="script"><link rel="prefetch" href="/assets/os.html-795f06e7.js" as="script"><link rel="prefetch" href="/assets/index.html-88714252.js" as="script"><link rel="prefetch" href="/assets/index.html-a85c0332.js" as="script"><link rel="prefetch" href="/assets/index.html-2aa29184.js" as="script"><link rel="prefetch" href="/assets/mysql.html-25eb7913.js" as="script"><link rel="prefetch" href="/assets/redis2.html-eaba2519.js" as="script"><link rel="prefetch" href="/assets/index.html-f41274b4.js" as="script"><link rel="prefetch" href="/assets/javaBasic.html-acfa3137.js" as="script"><link rel="prefetch" href="/assets/juc.html-26b0f929.js" as="script"><link rel="prefetch" href="/assets/jvm.html-5e543406.js" as="script"><link rel="prefetch" href="/assets/logframework.html-10116390.js" as="script"><link rel="prefetch" href="/assets/index.html-7622cd18.js" as="script"><link rel="prefetch" href="/assets/404.html-67fe96d7.js" as="script"><link rel="prefetch" href="/assets/index.html-5e529fc8.js" as="script"><link rel="prefetch" href="/assets/index.html-982d51c0.js" as="script"><link rel="prefetch" href="/assets/index.html-be85853f.js" as="script"><link rel="prefetch" href="/assets/index.html-3724d8a5.js" as="script"><link rel="prefetch" href="/assets/index.html-07c306f8.js" as="script"><link rel="prefetch" href="/assets/index.html-778c5f23.js" as="script"><link rel="prefetch" href="/assets/index.html-eb8d401c.js" as="script"><link rel="prefetch" href="/assets/index.html-6f56f6a7.js" as="script"><link rel="prefetch" href="/assets/index.html-34e220f8.js" as="script"><link rel="prefetch" href="/assets/index.html-4263ea52.js" as="script"><link rel="prefetch" href="/assets/index.html-d5e71dcb.js" as="script"><link rel="prefetch" href="/assets/index.html-e11125cc.js" as="script"><link rel="prefetch" href="/assets/index.html-fd5fd96b.js" as="script"><link rel="prefetch" href="/assets/index.html-9540ba52.js" as="script"><link rel="prefetch" href="/assets/index.html-b945c3be.js" as="script"><link rel="prefetch" href="/assets/index.html-2820b3b4.js" as="script"><link rel="prefetch" href="/assets/index.html-6b286caa.js" as="script"><link rel="prefetch" href="/assets/index.html-7c64505e.js" as="script"><link rel="prefetch" href="/assets/index.html-daf943b9.js" as="script"><link rel="prefetch" href="/assets/index.html-1b06884d.js" as="script"><link rel="prefetch" href="/assets/index.html-13a115e4.js" as="script"><link rel="prefetch" href="/assets/index.html-6b464bf3.js" as="script"><link rel="prefetch" href="/assets/index.html-240aa7ad.js" as="script"><link rel="prefetch" href="/assets/index.html-142c1e40.js" as="script"><link rel="prefetch" href="/assets/index.html-7a2e2e18.js" as="script"><link rel="prefetch" href="/assets/index.html-83a5b552.js" as="script"><link rel="prefetch" href="/assets/index.html-b656d3e9.js" as="script"><link rel="prefetch" href="/assets/index.html-50423b27.js" as="script"><link rel="prefetch" href="/assets/index.html-d46d6b52.js" as="script"><link rel="prefetch" href="/assets/index.html-ea08d835.js" as="script"><link rel="prefetch" href="/assets/index.html-3960a437.js" as="script"><link rel="prefetch" href="/assets/index.html-fdd641e9.js" as="script"><link rel="prefetch" href="/assets/index.html-bf690e14.js" as="script"><link rel="prefetch" href="/assets/index.html-042a91b4.js" as="script"><link rel="prefetch" href="/assets/index.html-37a439aa.js" as="script"><link rel="prefetch" href="/assets/index.html-0e2844a6.js" as="script"><link rel="prefetch" href="/assets/index.html-d0ab65af.js" as="script"><link rel="prefetch" href="/assets/index.html-7a6b2c2a.js" as="script"><link rel="prefetch" href="/assets/index.html-a8523b53.js" as="script"><link rel="prefetch" href="/assets/index.html-bbff7094.js" as="script"><link rel="prefetch" href="/assets/index.html-2a8b2480.js" as="script"><link rel="prefetch" href="/assets/index.html-440ff5cc.js" as="script"><link rel="prefetch" href="/assets/index.html-8929c8e8.js" as="script"><link rel="prefetch" href="/assets/index.html-8c754e85.js" as="script"><link rel="prefetch" href="/assets/index.html-15ddd5a6.js" as="script"><link rel="prefetch" href="/assets/index.html-d8652f99.js" as="script"><link rel="prefetch" href="/assets/index.html-42c4d3c3.js" as="script"><link rel="prefetch" href="/assets/index.html-6f16ca1e.js" as="script"><link rel="prefetch" href="/assets/index.html-5be922c3.js" as="script"><link rel="prefetch" href="/assets/index.html-f1e5b07d.js" as="script"><link rel="prefetch" href="/assets/index.html-3efc8747.js" as="script"><link rel="prefetch" href="/assets/index.html-43ba9fa3.js" as="script"><link rel="prefetch" href="/assets/index.html-46f5b9ca.js" as="script"><link rel="prefetch" href="/assets/index.html-23d03ef1.js" as="script"><link rel="prefetch" href="/assets/index.html-d6b95125.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-3ee328cd.js" as="script"><link rel="prefetch" href="/assets/pageview-1791e8aa.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt="txy"><!----><span class="vp-site-name hide-in-pad">txy</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="技术"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>技术</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="计算机基础" class="vp-link nav-link nav-link" href="/tech/basic.html"><!---->计算机基础<!----></a></li><li class="dropdown-item"><a aria-label="算法" class="vp-link nav-link nav-link" href="/tech/algorithms.html"><!---->算法<!----></a></li><li class="dropdown-item"><a aria-label="数据库" class="vp-link nav-link active nav-link active" href="/tech/database.html"><!---->数据库<!----></a></li><li class="dropdown-item"><a aria-label="Java" class="vp-link nav-link nav-link" href="/tech/java.html"><!---->Java<!----></a></li><li class="dropdown-item"><a aria-label="大数据" class="vp-link nav-link nav-link" href="/tech/bigdata.html"><!---->大数据<!----></a></li><li class="dropdown-item"><a aria-label="中间件" class="vp-link nav-link nav-link" href="/tech/middleware.html"><!---->中间件<!----></a></li><li class="dropdown-item"><a aria-label="云原生" class="vp-link nav-link nav-link" href="/tech/cloudnative.html"><!---->云原生<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a aria-label="随笔" class="vp-link nav-link nav-link" href="/essays.html"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>随笔<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="学习笔记"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>学习笔记</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="xxx项目" class="vp-link nav-link nav-link" href="/notes/xxx.html"><!---->xxx项目<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a aria-label="兴趣爱好" class="vp-link nav-link nav-link" href="/hobbies.html"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>兴趣爱好<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/fuzhengwei/xfg-resume-blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="数据库" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/tech/database/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>数据库<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="MYSQL" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/tech/database/mysql.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>MYSQL<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Redis(上)" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/tech/database/redis1.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Redis(上)<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="String" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#string"><!---->String<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="结构" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#结构"><!---->结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Hash" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#hash"><!---->Hash<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="结构" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#结构-1"><!---->结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="语法" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#语法"><!---->语法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景-1"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="List" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#list"><!---->List<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="结构" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#结构-2"><!---->结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="语法" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#语法-1"><!---->语法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景-2"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Set" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#set"><!---->Set<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="结构" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#结构-3"><!---->结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="语法" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#语法-2"><!---->语法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景-3"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Zset" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#zset"><!---->Zset<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="结构" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#结构-4"><!---->结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="语法" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#语法-3"><!---->语法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景-4"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="其他数据类型" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#其他数据类型"><!---->其他数据类型<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="跳表" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#跳表"><!---->跳表<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="单线程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#单线程"><!---->单线程<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="redis单线程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#redis单线程"><!---->redis单线程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="单线程为什么快？" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#单线程为什么快"><!---->单线程为什么快？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="后台线程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#后台线程"><!---->后台线程<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="执行流程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#执行流程"><!---->执行流程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AOF日志" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#aof日志"><!---->AOF日志<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="顺序" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#顺序"><!---->顺序<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="写回策略" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#写回策略"><!---->写回策略<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AOF重写机制" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#aof重写机制"><!---->AOF重写机制<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RDB快照" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#rdb快照"><!---->RDB快照<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="为什么有RDB？" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#为什么有rdb"><!---->为什么有RDB？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RDB命令" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#rdb命令"><!---->RDB命令<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RDB修改数据" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#rdb修改数据"><!---->RDB修改数据<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="混合持久化" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#混合持久化"><!---->混合持久化<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="过程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#过程"><!---->过程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="主从复制" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#主从复制"><!---->主从复制<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="非强一致性" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#非强一致性"><!---->非强一致性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="哨兵模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#哨兵模式"><!---->哨兵模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="切片集群模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#切片集群模式"><!---->切片集群模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="方案" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#方案"><!---->方案<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="脑裂" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#脑裂"><!---->脑裂<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="一致性hash算法" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#一致性hash算法"><!---->一致性hash算法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="过期删除" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#过期删除"><!---->过期删除<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="过期" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#过期"><!---->过期<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="删除" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#删除"><!---->删除<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="持久化|过期键" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#持久化-过期键"><!---->持久化|过期键<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="内存淘汰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#内存淘汰"><!---->内存淘汰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="缓存更新" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#缓存更新"><!---->缓存更新<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="旁路缓存" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#旁路缓存"><!---->旁路缓存<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="一致性缓存问题" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#一致性缓存问题"><!---->一致性缓存问题<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="方案" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#方案-1"><!---->方案<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="方案一" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#方案一"><!---->方案一<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="方案二" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#方案二"><!---->方案二<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="方案三" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#方案三"><!---->方案三<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="缓存穿透、雪崩、击穿" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#缓存穿透、雪崩、击穿"><!---->缓存穿透、雪崩、击穿<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="缓存穿透" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#缓存穿透"><!---->缓存穿透<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="缓存雪崩" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#缓存雪崩"><!---->缓存雪崩<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="缓存击穿" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#缓存击穿"><!---->缓存击穿<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="redis实现延迟队列" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#redis实现延迟队列"><!---->redis实现延迟队列<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="场景" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#场景-6"><!---->场景<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="实现" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#实现"><!---->实现<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="redis大key如何处理" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#redis大key如何处理"><!---->redis大key如何处理<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="获取大key" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#获取大key"><!---->获取大key<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="删除大key" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#删除大key"><!---->删除大key<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="redis管道有什么用？" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#redis管道有什么用"><!---->redis管道有什么用？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="redis事务支持回滚吗" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#redis事务支持回滚吗"><!---->redis事务支持回滚吗<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="如何实现分布式锁？" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/tech/database/redis1.html#如何实现分布式锁"><!---->如何实现分布式锁？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="Redis(下)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/tech/database/redis2.html"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Redis(下)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Redis(上)</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 44 分钟</span><meta property="timeRequired" content="PT44M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category3 clickable" role="navigation">Redis</span><!--]--><meta property="articleSection" content="Redis"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag0 clickable" role="navigation">数据类型</span><span class="page-tag-item tag1 clickable" role="navigation">AOF&amp;RDB</span><span class="page-tag-item tag5 clickable" role="navigation">缓存一致性</span><span class="page-tag-item tag3 clickable" role="navigation">redis实战</span><!--]--><meta property="keywords" content="数据类型,AOF&amp;RDB,缓存一致性,redis实战"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#string">String</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#结构">结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景">场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#hash">Hash</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#结构-1">结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#语法">语法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景-1">场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#list">List</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#结构-2">结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#语法-1">语法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景-2">场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#set">Set</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#结构-3">结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#语法-2">语法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景-3">场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#zset">Zset</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#结构-4">结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#语法-3">语法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景-4">场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#其他数据类型">其他数据类型</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#跳表">跳表</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#单线程">单线程</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#redis单线程">redis单线程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#单线程为什么快">单线程为什么快？</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#后台线程">后台线程</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#执行流程">执行流程</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#aof日志">AOF日志</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#顺序">顺序</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#写回策略">写回策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#aof重写机制">AOF重写机制</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#rdb快照">RDB快照</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#为什么有rdb">为什么有RDB？</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#rdb命令">RDB命令</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#rdb修改数据">RDB修改数据</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#混合持久化">混合持久化</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#过程">过程</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#主从复制">主从复制</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#非强一致性">非强一致性</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#哨兵模式">哨兵模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#切片集群模式">切片集群模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#方案">方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#脑裂">脑裂</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#一致性hash算法">一致性hash算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#过期删除">过期删除</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#过期">过期</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#删除">删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#持久化-过期键">持久化|过期键</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#内存淘汰">内存淘汰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#缓存更新">缓存更新</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#旁路缓存">旁路缓存</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#一致性缓存问题">一致性缓存问题</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#方案-1">方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#方案一">方案一</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#方案二">方案二</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#方案三">方案三</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#缓存穿透、雪崩、击穿">缓存穿透、雪崩、击穿</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#缓存穿透">缓存穿透</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#缓存雪崩">缓存雪崩</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#缓存击穿">缓存击穿</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#redis实现延迟队列">redis实现延迟队列</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#场景-6">场景</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#实现">实现</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#redis大key如何处理">redis大key如何处理</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#获取大key">获取大key</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#删除大key">删除大key</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#redis管道有什么用">redis管道有什么用？</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#redis事务支持回滚吗">redis事务支持回滚吗</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#如何实现分布式锁">如何实现分布式锁？</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="·为什么用redis" tabindex="-1"><a class="header-anchor" href="#·为什么用redis" aria-hidden="true">#</a> ·为什么用redis</h1><p><strong><!----></strong><!----><!----><!----></p><p><strong><!----></strong><!----><!----><!----></p><p><strong><!----></strong><!----></p><p><strong><!----></strong><!----></p><!----><ol><li><!----></li><li><!----></li><li><!----></li><li><!----></li><li><!----></li></ol><!----><h1 id="·数据结构" tabindex="-1"><a class="header-anchor" href="#·数据结构" aria-hidden="true">#</a> ·数据结构</h1><h2 id="string" tabindex="-1"><a class="header-anchor" href="#string" aria-hidden="true">#</a> <!----></h2><!----><h3 id="结构" tabindex="-1"><a class="header-anchor" href="#结构" aria-hidden="true">#</a> <!----></h3><!----><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment">// 记录已使用的长度   </span>
    <span class="token keyword">int</span> free<span class="token punctuation">;</span> <span class="token comment">// 记录空闲未使用的长度</span>
    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span> <span class="token comment">// 字符数组</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cdn.nlark.com/yuque/0/2022/png/22839467/1654748250694-32d4c1c7-91f1-4ca3-9f4c-aa981245560a.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><!---->：1. 快速获取字符串长度O(1)。2. 拼接字符串时不会造成缓冲区溢出，追加机制，先看看空闲长度够不够，如果不够，会进行扩容，当小于1M，每次扩容加倍；否则每次扩容追加1M。<h3 id="场景" tabindex="-1"><a class="header-anchor" href="#场景" aria-hidden="true">#</a> 场景</h3><p>String常见的应用场景：缓存对象、一些计数、分布式锁等。共享session信息等(什么？)。</p><!----><h2 id="hash" tabindex="-1"><a class="header-anchor" href="#hash" aria-hidden="true">#</a> Hash</h2><h3 id="结构-1" tabindex="-1"><a class="header-anchor" href="#结构-1" aria-hidden="true">#</a> 结构</h3><!----><!---->哈希表或压缩列表，redis7.0：哈希表+listpack<p>如果哈希类型的元素个数小于512(hash-max-ziplist-entries)，所有值小于64字节(hash-max-ziplist-value)时，redis会使用<!---->作为hash类型的底层数据结构。如果不满足上面条件，redis会使用<!---->作为hash类型的底层数据结构。</p><p>与java的hashmap类似，类似于数组+链表的结构，当发生哈希碰撞时把元素追加到链表上。</p><h3 id="语法" tabindex="-1"><a class="header-anchor" href="#语法" aria-hidden="true">#</a> 语法</h3><p>hset key field value</p><p>hget key field</p><h3 id="场景-1" tabindex="-1"><a class="header-anchor" href="#场景-1" aria-hidden="true">#</a> 场景</h3><!---->Hash也可以用来缓存对象。String存的对象信息是经过<!---->后的字符串。如果想要修改某个用户字段必须将用户信息字符串全部查询出来，解析成相应的用户信息对象，修改完后在序列化成字符串存入。<p>Hash可以对用户信息的每个<!---->。而 hash可以只对某个字段修改，从而节约网络流量，不过hash内存占用要大于 String，这是 hash 的缺点。</p><h2 id="list" tabindex="-1"><a class="header-anchor" href="#list" aria-hidden="true">#</a> List</h2><h3 id="结构-2" tabindex="-1"><a class="header-anchor" href="#结构-2" aria-hidden="true">#</a> 结构</h3><!----><!---->压缩列表或双向链表，redis3.2版本开始是quicklist。<!---->当数据量较<!---->的时候，默认情况列表元素个数小于512个(可由list-max-ziplist-entries配置)，列表每个元素值都小于64字节(list-max-ziplist-value)，会使用压缩列表ziplist作为list的底层存储结构，它将所有的元素<!---->着一起存储，分配的是一块<!---->的内存；当不满足上面条件的时候将会使用双向链表作为list底层存储结构。<p>在redis3.2变成quicklist(<!---->)结构。ziplist+链表的混合结构，每一个节点存储prev和next指针，每个节点包含一个ziplist。</p><h3 id="语法-1" tabindex="-1"><a class="header-anchor" href="#语法-1" aria-hidden="true">#</a> 语法</h3><!---->rpush key value1 value2...<!----><h3 id="场景-2" tabindex="-1"><a class="header-anchor" href="#场景-2" aria-hidden="true">#</a> <!----></h3><!---->消息队列：lpop和rpush（或者反过来，lpush和rpop）能实现队列的功能。但是有2个问题：1. 生产者需要自行实现全局唯一ID，2. 不能以消费组形式消费数据。<h2 id="set" tabindex="-1"><a class="header-anchor" href="#set" aria-hidden="true">#</a> Set</h2><h3 id="结构-3" tabindex="-1"><a class="header-anchor" href="#结构-3" aria-hidden="true">#</a> 结构</h3><!---->哈希表或整数集合<p>如果集合的元素都是整数且元素个数小于512(set-maxintest-entries)个，redis会使用整数集合作为set的底层数据结构，否则会使用哈希表。</p><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><h3 id="语法-2" tabindex="-1"><a class="header-anchor" href="#语法-2" aria-hidden="true">#</a> <!----></h3><p>sadd key value</p><p>smembers key: key集合所有元素</p><p>scard key：获取集合长度</p><p>spop key：弹出一个元素</p><p>srem key value: 删除指定元素</p><p>sismember key value: 是否存在某个value</p><p>sinter命令可以获得A和B两个用户的共同好友；</p><h3 id="场景-3" tabindex="-1"><a class="header-anchor" href="#场景-3" aria-hidden="true">#</a> 场景</h3><p>比如在一些需要聚合计算（并集、交集、差集）场景，比如点赞、共同关注、抽奖活动等。</p><p>我项目中点赞时某个帖子的点赞人集合、帖子热度排行所需刷新的帖子id。</p><h2 id="zset" tabindex="-1"><a class="header-anchor" href="#zset" aria-hidden="true">#</a> Zset</h2><!----><h3 id="结构-4" tabindex="-1"><a class="header-anchor" href="#结构-4" aria-hidden="true">#</a> 结构</h3><!---->压缩列表或跳表，redis7.0：跳表+listpack<p>如果有序集合的元素个数小于128个，每个元素的值小于64个字节时，使用压缩列表。否则使用跳表。</p><p>在redis7.0中，不用压缩列表了，改用listpack数据结构实现。</p><h3 id="语法-3" tabindex="-1"><a class="header-anchor" href="#语法-3" aria-hidden="true">#</a> 语法</h3><p>zadd key score value</p><p>zcard key</p><p>zrange key start_index end_index: 获取下标范围内的元素列表，按score排序输出。</p><p>zscore key value: 获取元素的score</p><h3 id="场景-4" tabindex="-1"><a class="header-anchor" href="#场景-4" aria-hidden="true">#</a> 场景</h3><!----><!----><!----><h2 id="其他数据类型" tabindex="-1"><a class="header-anchor" href="#其他数据类型" aria-hidden="true">#</a> 其他数据类型</h2><!----><!----><!----><!----><!----><h2 id="跳表" tabindex="-1"><a class="header-anchor" href="#跳表" aria-hidden="true">#</a> <!----></h2><!----><figure><img src="https://cdn.nlark.com/yuque/0/2022/png/22839467/1654757589168-78b4a5dd-ae47-41f4-98b8-67e3349c7931.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="·线程模型" tabindex="-1"><a class="header-anchor" href="#·线程模型" aria-hidden="true">#</a> ·线程模型</h1><h2 id="单线程" tabindex="-1"><a class="header-anchor" href="#单线程" aria-hidden="true">#</a> 单线程</h2><p>redis的网络IO和执行命令是单线程的。接收客户端请求-&gt;解析请求-&gt;数据读写-&gt;发送数据给客户端，这个过程是由一个线程（主线程）来完成的。</p><p>定义：</p><ol><li>调用过程发送命令、执行命令、返回结果三个过程。</li><li>在执行命令阶段，redis是按照单线程来处理的。</li><li>命令到达服务端，不会立即执行，被放入队列里，然后逐个被执行。</li></ol><p>好处：</p><ol><li>不会产生并发问题。</li></ol><h3 id="redis单线程" tabindex="-1"><a class="header-anchor" href="#redis单线程" aria-hidden="true">#</a> redis单线程</h3><figure><img src="https://cdn.nlark.com/yuque/0/2022/png/22839467/1658552584751-f02d2966-bc2f-4e27-af5b-6ed929be089b.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化" aria-hidden="true">#</a> 初始化</h4><ol><li>调用epoll_create()创建一个epoll对象。</li><li>调用bind()绑定端口，调用listen()监听该socket</li><li>然后调用epoll_ctl()把listen socket加入到epoll，同时注册[连接事件]处理函数</li></ol><h4 id="事件循环函数" tabindex="-1"><a class="header-anchor" href="#事件循环函数" aria-hidden="true">#</a> 事件循环函数</h4><ol><li>先调用处理发送队列函数，看发送队列是否有任务，如果有，则通过write将客户端发送缓冲区的数据发送出去，如果这一轮数据没有发送完，就会注册写事件处理函数，等待epoll_wait发现可写后再处理。</li><li>接着，调用epoll_wait函数等待事件的到来： <ol><li>如果是连接事件，则会调用连接事件处理函数：调用accept获取已连接的socket-&gt;调用epoll_ctl将已连接的socket加入到epoll-&gt;注册读事件处理函数。</li><li>如果是读事件到来，则会调用读事件处理函数：调用read获取客户端发送的数据-&gt;解析命令-&gt;处理命令-&gt;将客户端对象添加到发送队列-&gt;将执行结果写到发送缓存区等待发送。</li><li>如果是写事件到来，则会调用写事件处理函数：通过write函数将客户端发送缓存区里的数据发送出去，如果这一轮数据没有发生完，就会继续注册写事件处理函数，等待epoll_wait发现可写后再处理。</li></ol></li></ol><h3 id="单线程为什么快" tabindex="-1"><a class="header-anchor" href="#单线程为什么快" aria-hidden="true">#</a> 单线程为什么快？</h3><ol><li>redis的大部分操作在内存中完成+高效的数据结构。所以redis的性能瓶颈是内存或者网络带宽，而不是CPU，所以采用单线程。</li><li>单线程可以避免多线程的竞争，省去了线程切换带来的时间+性能上的开销，而且不会产生死锁。</li><li>redis采用IO多路复用处理客户端的socket请求，就是一个线程处理多个IO流，也就是一个线程监听多个socket连接或数据请求，如果有请求到达，就会交给redis线程处理。</li></ol><h2 id="后台线程" tabindex="-1"><a class="header-anchor" href="#后台线程" aria-hidden="true">#</a> 后台线程</h2><p>redis程序并不是单线程的，redis在启动时，是会启动后台线程的。</p><p>比如[关闭文件、AOF刷盘、释放redis内存]的任务是创建单独的线程来处理的，因为这些任务的操作是很耗时的。</p><p>比如[释放redis内存]，如果用删除一个大的key时，用del命令是在主线程处理的，会导致redis主线程卡顿。所以使用unlink key删除命令，会异步的由后台线程来执行删除操作，不会导致主线程卡顿。</p><h3 id="执行流程" tabindex="-1"><a class="header-anchor" href="#执行流程" aria-hidden="true">#</a> 执行流程</h3><p>生产者把相关的任务放到任务队列中，后台线程相当于消费者，从消息队列拿任务执行对应的方法。</p><h1 id="·redis持久化" tabindex="-1"><a class="header-anchor" href="#·redis持久化" aria-hidden="true">#</a> ·Redis持久化</h1><p>redis读写操作在内存，当redis重启后，内存数据就会丢失，所以redis具有持久化的机制，把数据存储到磁盘，这样redis重启后就能从磁盘恢复原有的数据。</p><h2 id="aof日志" tabindex="-1"><a class="header-anchor" href="#aof日志" aria-hidden="true">#</a> AOF日志</h2><p>每执行一条写操作命令，就把该命令以追加的方式写入到一个文件里。在redis重启时，会读取该文件记录的命令，然后逐一执行进行数据恢复。</p><h3 id="顺序" tabindex="-1"><a class="header-anchor" href="#顺序" aria-hidden="true">#</a> 顺序</h3><p>先执行命令，再把数据写入日志。</p><p>如果先把写命令记录到AOF日志，再执行命令的话，如果当前的命令语法有问题，那么错误的命令记录到日志后，在redis使用日志恢复数据时，可能会出错。</p><p>而且这样不会阻塞当前也操作命令的执行，因为只有执行完以后才记录到AOF日志中。</p><p>不过可能会产生一些风险，比如执行完命令，还没来得及把命令写入硬盘时，服务器宕机了，那么这个数据会有丢失的风险。</p><p>因为AOF也是在主线程执行的，虽然不会阻塞当前命令的执行，但是可能会阻塞其他的操作。</p><h3 id="写回策略" tabindex="-1"><a class="header-anchor" href="#写回策略" aria-hidden="true">#</a> 写回策略</h3><ol><li>redis执行完写操作命令后，会将命令追加到server.aof_buf缓冲区。</li><li>通过write()系统调用，把aof_buf缓冲区的数据拷贝到内核缓冲区page cache，等待内核将数据写入硬盘也就是AOF日志文件。</li><li>具体内核缓冲区的数据什么时候写入硬盘，由内核决定。redis.conf配置，appendfsync配置项。 <ol><li>Always：总是，同步写回，意思是每次写操作命令执行完，同步将数据写回硬盘。可靠性高，但是每个写命令写回硬盘，性能开销大。</li><li>Everysec：每次写操作命令执行完后，先将命令写入AOF文件内核缓冲区，然后每隔一秒将缓冲区的内容写回硬盘。性能适中，但是宕机时会丢失1秒内的数据。</li><li>No：由操作系统控制写回的时机，也就是写操作执行完后，先将命令写入AOF文件的内核缓冲区，再由操作系统决定何时将缓冲区内容写回硬盘。性能好，宕机时可能会丢数据。</li></ol></li></ol><h3 id="aof重写机制" tabindex="-1"><a class="header-anchor" href="#aof重写机制" aria-hidden="true">#</a> AOF重写机制</h3><p>AOF的文件过大会带来性能问题，恢复过程就会很慢。AOF重写机制就是当文件大小超过所设定的阈值，就会启用AOF重写机制，压缩AOF文件。</p><h4 id="方法" tabindex="-1"><a class="header-anchor" href="#方法" aria-hidden="true">#</a> 方法</h4><p>读取所有键值对，把一些重复的或者可以覆盖的命令用一条新的命令替换，记录到新的AOF文件。全部记录完后，把新的AOF文件替换掉现有的。</p><h4 id="子进程" tabindex="-1"><a class="header-anchor" href="#子进程" aria-hidden="true">#</a> 子进程</h4><p>重写AOF过程是后台子进程bgrewriteaof来完成的，子进程AOF重写期间，主进程可以继续处理命令请求，避免阻塞。</p><p>子进程带有主进程的数据副本，这里使用子进程而不是线程，是因为如果使用线程，多线程之间会共享内存，在修改共享内存数据的时候，需要通过加锁来保证数据安全，而这样会降低性能，使用子进程，父子进程是共享内存的，不过只能只读，当父子进程任意一方修改了共享内存数据，就会发生写时复制，于是父子进程就有了独立的数据副本，就不用加锁来保证数据安全。</p><h5 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h5><p>重写AOF日志过程中，如果主进程修改了已经存在的key-value，那么会发生写时复制，此时数据在主进程内存数据和子进程的内存数据不一致了。</p><p>redis设置了一个AOF重写缓冲区，在重写AOF期间，当redis执行完一个写命令后，会将这个写命令写入AOF缓冲区和AOF重写缓冲区。当子进程完成AOF重写后，向主进程发送一个信号，主进程收到信号后，会调用一个信号处理函数，将AOF重写缓冲区的所有内容追加到新的AOF文件，新的AOF文件进行改名，覆盖现有AOF文件。</p><h2 id="rdb快照" tabindex="-1"><a class="header-anchor" href="#rdb快照" aria-hidden="true">#</a> RDB快照</h2><p>将某一时刻的内存数据，以二进制的方式写入磁盘。</p><h3 id="为什么有rdb" tabindex="-1"><a class="header-anchor" href="#为什么有rdb" aria-hidden="true">#</a> 为什么有RDB？</h3><p>因为AOF记录的是操作命令，所以做故障恢复时，需要全量把日志都执行一遍，那么如果AOF日志非常多，会造成数据恢复缓慢。</p><p>RDB快照就是记录某个瞬间的内存实际数据，所以恢复数据时，RDB恢复数据的效率会比AOF高，因为直接将RDB文件读入内存就可以，不需要像AOF那样执行额外的操作命令才能恢复数据。</p><h3 id="rdb命令" tabindex="-1"><a class="header-anchor" href="#rdb命令" aria-hidden="true">#</a> RDB命令</h3><ol><li>save：会在主线程生成RDB文件，阻塞主线程。</li><li>bgsave：创建一个子线程生成RDB文件，避免主线程阻塞。redis提供配置实现每隔一段时间自动执行bgsave。</li></ol><h3 id="rdb修改数据" tabindex="-1"><a class="header-anchor" href="#rdb修改数据" aria-hidden="true">#</a> RDB修改数据</h3><p>执行bgsave时，redis依然可以继续处理写数据命令，关键技术就是写时复制COW。</p><p>如果主线程执行写操作，被修改的数据会复制一份副本，然后bgsave子进程会把副本数据写入RDB文件，与此同时，主进程仍然可以修改原来的数据。</p><h2 id="混合持久化" tabindex="-1"><a class="header-anchor" href="#混合持久化" aria-hidden="true">#</a> 混合持久化</h2><p>集成了AOF和RDB的优点。</p><p>RDB优点是恢复数据速度快，但是快照的频率，如果太低，那么可能会丢失数据，太高，会影响性能。</p><p>AOF优点是丢失数据少，但是数据恢复不快。</p><p>混合持久化就是继承两者的优点，既保证了重启的速度，又降低数据的丢失风险。</p><h3 id="过程" tabindex="-1"><a class="header-anchor" href="#过程" aria-hidden="true">#</a> 过程</h3><p>在AOF重写日志时，fork出来的重写子进程会将于主线程共享的内存数据以RDB方式写入AOF文件，然后主线程处理的操作命令会被记录在重写缓冲区中，增量会以AOF方式写入AOF文件，写完后通知主进程把含有RDB格式和AOF格式的AOF文件替换旧的AOF文件。</p><p>在恢复数据的时候，前半部分是RDB内容，加载时速度很快，加载完才会加载后半部分AOF内容，减少数据的丢失。</p><h1 id="·redis集群" tabindex="-1"><a class="header-anchor" href="#·redis集群" aria-hidden="true">#</a> ·Redis集群</h1><h2 id="主从复制" tabindex="-1"><a class="header-anchor" href="#主从复制" aria-hidden="true">#</a> 主从复制</h2><p>写操作在主服务器进行，从服务器一般是只读，主服务器把数据同步给从服务器，从服务器接收主服务器同步过来的写操作命令，然后执行，保证主从服务器的数据一致。</p><h3 id="非强一致性" tabindex="-1"><a class="header-anchor" href="#非强一致性" aria-hidden="true">#</a> 非强一致性</h3><p>主从服务器的命令复制是异步进行的，主服务器收到写命令，会发送给从服务器，主服务器执行完以后把结果返回给客户端，但这个时候从服务器可能还没执行，会导致主从服务器间的数据不一致。</p><h2 id="哨兵模式" tabindex="-1"><a class="header-anchor" href="#哨兵模式" aria-hidden="true">#</a> 哨兵模式</h2><p>监控、提醒、故障转移。监控主从服务器，提供主从故障转移的功能。哨兵节点对其余的Sentinel节点进行监控，发现节点不可达会做下线的标识，如果被标识的是主节点，那么会和其他哨兵节点进行协商投票，当大多数哨兵认为主节点不可达时，会判定下线，并选举一个leader进行故障转移的操作。</p><h2 id="切片集群模式" tabindex="-1"><a class="header-anchor" href="#切片集群模式" aria-hidden="true">#</a> 切片集群模式</h2><p>当redis缓存数据量大到一台服务器无法缓存时，就会使用redis切片集群，把数据分布到不同的服务器上，降低对单主节点的依赖，提高redis服务的读写性能。</p><h3 id="方案" tabindex="-1"><a class="header-anchor" href="#方案" aria-hidden="true">#</a> 方案</h3><p>哈希槽，一个切片集群共有16384个哈希槽，数据会根据key，按照CRC16算法计算一个16bit的值，然后对16384取模，映射到一个哈希槽。</p><p>然后哈希槽映射到具体的redis节点。</p><p>方案一：平均分配，哈希槽会平均分布到集群节点上，比如有9个节点，每个节点的哈希槽个数就是16384/9。</p><p>方案二：手动分配，手动指定节点上的哈希槽，建立节点间的连接。</p><h3 id="脑裂" tabindex="-1"><a class="header-anchor" href="#脑裂" aria-hidden="true">#</a> 脑裂</h3><p>redis主从架构中，主节点提供写操作，从节点提供读操作，如果主节点网络发生问题，与从节点失联，但是和客户端的网络是正常的，客户端继续向这个主节点写数据，但是这些数据没办法同步给从节点。哨兵也发现主节点失联了，认为主节点挂了，然后从从节点中选举一个leader作为主节点，这时集群出现了2个主节点。就是脑裂。然后网络突然好了，哨兵就会把旧主节点降级为从节点，然后这个节点向新主节点请求数据同步，第一次同步是全量同步，先清空自己本地数据，然后做全量同步，所以，旧主节点之前写入的数据就丢失了，也就是集群脑裂数据丢失的问题。</p><h4 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案</h4><p>主节点连接的从节点个数如果小于一个设定的阈值或者进行主从数据复制时ACK延迟超过设定的阈值时，主库就不再接收客户端的写请求了。</p><p>这样新主库上线后，原主库会降为从库，即使数据被清空了，也不会有新数据丢失。</p><h2 id="一致性hash算法" tabindex="-1"><a class="header-anchor" href="#一致性hash算法" aria-hidden="true">#</a> 一致性hash算法</h2><ol><li>主要是解决分布式缓存问题，比如分布式redis。</li><li>在删除或者添加一个服务器时，能尽可能的减少改变对服务器请求和服务器的映射关系。</li></ol><p>假如我们有3台服务器，我们对redis服务器进行访问时，需要把请求分到一台服务器上，可以通过hash，取模运算，%3计算结果映射到对应的服务器。</p><p>这样如果我们的服务器不够用了，需要增加服务器数量，那么在对请求重新分配时，取模运算计算的结果都和刚才不一样了，所以访问的缓存位置都要发生变化，那当我们无法在redis获取数据时，就需要向比如mysql数据库取请求数据。同理如果某一台服务器挂掉了。可能导致大量缓存失效，造成缓存雪崩，后端服务器将会承受巨大压力。所以出现了一致性hash算法。</p><p>一致性hash也是取模的方法，但是是对2<sup>32取模。可以想象2</sup>32个值按照顺时针的方向组成一个环，称为hash环。服务器使用hash函数取模，映射到hash环上的一个位置。数据访问时根据key计算hash值取模，然后确定在环上的位置，然后按照顺时针的方向，遇到的第一个服务器就是定位到的服务器。</p><p>如果哈希环上的服务器几点太少，可能会导致节点分布不均匀产生数据倾斜，很多缓存的对象都集中在某一台服务器上，可能会导致系统的崩溃。解决办法就是引入了虚拟节点。虚拟节点就是一个真实节点会对应到几个虚拟节点，增加哈希环上服务器的数量，尽量让服务器在环上的分布更均匀一些。在定位服务器的时候，根据定位到的服务器，可能是虚拟节点，再通过虚拟节点定位到真实节点。</p><h1 id="·缓存设计" tabindex="-1"><a class="header-anchor" href="#·缓存设计" aria-hidden="true">#</a> ·缓存设计</h1><h2 id="过期删除" tabindex="-1"><a class="header-anchor" href="#过期删除" aria-hidden="true">#</a> 过期删除</h2><h3 id="过期" tabindex="-1"><a class="header-anchor" href="#过期" aria-hidden="true">#</a> 过期</h3><p>对某一个key设置过期时间时，redis会把key带上过期时间存储在一个过期字典里。</p><p>查询一个key时，先检查key是否在过期字典里，如果不在，正常读取键值，如果在，获取该key的过期时间，然后和当前时间比较，如果小于当前时间就没过期，否则就过期。</p><h3 id="删除" tabindex="-1"><a class="header-anchor" href="#删除" aria-hidden="true">#</a> 删除</h3><h4 id="惰性删除" tabindex="-1"><a class="header-anchor" href="#惰性删除" aria-hidden="true">#</a> 惰性删除</h4><p>惰性删除：不会主动删除过期的键，查询某一个键时，如果过期了就删除key。</p><p>优点：访问数据时检查key是否过期，所以会占用少的系统资源。</p><p>缺点：如果一个key已经过期，但是很久都没有被访问，那么kkey一直存在内存中不被释放，造成内存空间的浪费。</p><h4 id="定期删除" tabindex="-1"><a class="header-anchor" href="#定期删除" aria-hidden="true">#</a> 定期删除</h4><p>流程：</p><ol><li>从过期字典中随机抽20个key。</li><li>检查是否过期，并删除过期的key。</li><li>如果过期数量超过5个，也就是占比大于25%，那么重复步骤一，否则停止。为了防止一直循环的情况，还设定了一个删除循环流程的时间上限，25ms。</li></ol><p>优点：既能删除无用的key，同时也有最长执行时间的上限。</p><p>缺点：难以确定执行的频率，如果太频繁，对CPU不友好，如果执行的太少，那就和惰性删除一样，某些key不会被及时释放。</p><h3 id="持久化-过期键" tabindex="-1"><a class="header-anchor" href="#持久化-过期键" aria-hidden="true">#</a> 持久化|过期键</h3><h4 id="rdb" tabindex="-1"><a class="header-anchor" href="#rdb" aria-hidden="true">#</a> RDB</h4><p>RDB文件生成阶段，会对key进行过期检查，如果过期不会背保存在RDB中。</p><p>RDB加载阶段，主服务器，加载RDB文件时，会对键进行检查，过期的不会被载入数据库中。如果是从服务器，不会判断是否过期，在主从服务器进行数据同步时，从服务器数据会被清空。</p><h4 id="aof" tabindex="-1"><a class="header-anchor" href="#aof" aria-hidden="true">#</a> AOF</h4><p>AOF文件写入阶段，如果某个过期的键没被删除，AOF会保留这个过期的键。当过期的键被删除后，Redis会向AOF文件中追加一条DEL命令删除这个键。</p><p>在AOF重写阶段：执行AOF重写时，如果键已过期，不会被保存在重写的AOF文件中。</p><h4 id="redis主从模式" tabindex="-1"><a class="header-anchor" href="#redis主从模式" aria-hidden="true">#</a> redis主从模式</h4><p>从库不会主动扫描，从库过期键的处理时依靠主服务器控制，主库key过期，会在AOF文件增加一条指令，同步到从库时，从库执行这条指令删除过期的key。</p><h2 id="内存淘汰" tabindex="-1"><a class="header-anchor" href="#内存淘汰" aria-hidden="true">#</a> 内存淘汰</h2><p><strong>不进行数据淘汰</strong>，当运行内存超最大限制，不再提供服务，返回错误。</p><p><strong>进行数据淘汰策略</strong>：</p><p>在设置了过期时间的数据中进行淘汰：</p><ol><li>随机淘汰设置了过期时间的任意键值。</li><li>优先淘汰更早过期的键值。</li><li>淘汰设置了过期时间键值中最久未使用的键值。lru。【淘汰最近最少使用的数据】</li><li>淘汰设置了过期时间键值中最少使用的兼职。lfu。</li></ol><p>在所有数据范围内进行淘汰：</p><ol><li>随机淘汰任意键值。</li><li>淘汰整个键值中最久未使用的键值。lru。</li><li>淘汰整个键值中最少使用的键值。lfu。</li></ol><p>LRU：</p><p>基于链表结构，最新操作的元素会被移到链表头，那么链表尾就是最久未使用的元素。</p><p>缺点：链表带来额外的空间开销。当数据被访问时，把数据移动到头，链表操作会比较耗时，降低redis性能。</p><p>LFU：</p><p>最近最不常用的。根据访问次数淘汰数据的，思想是：如果数据过去被访问多次，那么将来被访问的频率会更高。所以LFU会记录每个数据的访问次数，当一个数据被再次访问时，就会增加该数据的访问次数。这样就解决了可能某个key被偶尔访问了一次，数据却能留存很长时间的问题。</p><h2 id="缓存更新" tabindex="-1"><a class="header-anchor" href="#缓存更新" aria-hidden="true">#</a> 缓存更新</h2><p>redis在使用过程中需要保证数据的<!---->和<!---->，所以要做<!---->的操作，缓存更新可以分为。</p><h3 id="旁路缓存" tabindex="-1"><a class="header-anchor" href="#旁路缓存" aria-hidden="true">#</a> 旁路缓存</h3><ol><li>读更写删</li></ol><p>一般在<!---->的时候，如果缓存未命中，则查数据库，然后<!---->缓存。</p><p>在<!---->数据库的时候，去<!---->缓存。</p><ol start="2"><li>旁路更新</li></ol><!----><!----><!----><ol start="3"><li><!----></li></ol><!----><!----><!----><!----><!----><ol start="4"><li><!----></li></ol><!----><!----><!----><!----><!----><!----><!----><ol><li><!----></li><li><!----></li></ol><h2 id="一致性缓存问题" tabindex="-1"><a class="header-anchor" href="#一致性缓存问题" aria-hidden="true">#</a> 一致性缓存问题</h2><h3 id="方案-1" tabindex="-1"><a class="header-anchor" href="#方案-1" aria-hidden="true">#</a> 方案</h3><p>对于写，一共有四种方案。我选择的方案是先删除缓存再更新DB，再异步的将数据刷新回缓存。</p><p>旁路缓存是对并发问题比较友好，但是容灾问题我不知道怎么解决。但是我所说的都有对应的解决并发和容灾问题的方案。对于先更新数据库，再删除缓存的方法，如果说删除缓存失败了，确实是可以通过再异步更新缓存的方式，但是这段时间内用户去访问数据时，拿到的是旧数据，很奇怪，对于用户来说更新数据库是成功的，并不会告诉用户更新失败。而拿到的确实旧数据，对用户来说是很奇怪的一件事。</p><h3 id="方案一" tabindex="-1"><a class="header-anchor" href="#方案一" aria-hidden="true">#</a> 方案一</h3><p>写：第一步删除缓存，删除之后再更新DB，之后再异步将数据刷回缓存。</p><p>读：第一步先读缓存，如果缓存没读到，则去读DB，之后再将数据异步刷回缓存。</p><p>对于写流程：【不采用xxx】</p><ol><li>如果先更新缓存，再更新数据库。那么如果缓存更新成功，而数据库更新失败，就会导致缓存中的是错误数据，那么数据错误我们是无法忍受的。</li><li>如果先更新数据库，再更新缓存。那么如果我们数据库更新成功，缓存更新失败，则会导致缓存中的数据是旧数据。也不合理。</li><li>同时对于上述两种情况，如果有2个线程并发更新，拿先更新数据库，再更新缓存为例。A线程要把数据更新为1，B线程要把数据更新为2。下面他们的执行顺序如果是这样的，A先更新数据库为1，然后B线程也更新了数据库为2，然后B线程更新了缓存为2，然后A线程更新缓存为1。导致数据库中的数据是2，而缓存中的数据是1这种缓存和数据的不一致。</li><li>异步刷新：无论是redis还是mysql，在操作数据失败的时候都是会报错返回错误信息的，但是业务中缓存只是辅助，对缓存操作失败不应该影响主程序。也就是缓存操作失败了，我们可能try...catch处理一下，还是让程序继续运行。那么对于先删除缓存，再更新数据库，如果第一步缓存删除失败了，而数据库更新成功了，我们可以加一个第三步异步的更新缓存，从而降低第一步失败造成的后果。而如果缓存删除成功了，而数据库更新失败了，那么我们对数据库操作是相当于主要的操作，那么我们就不继续向下执行了，这时的状态是缓存中没有数据，而数据库更新失败，那么用户使用时也不会有缓存和数据库数据不一致的情况，因为缓存中拿不到数据就可以去数据库中拿了。</li><li>而如果先更新数据库，再删除缓存，可能会导致如果数据库更新成功了，而缓存更新失败了的情况，导致缓存的是旧数据，数据库是新数据这种情况。</li></ol><p>也存在缺点：</p><ol><li>容灾：如果删除缓存失败了，继续向下执行，而数据库更新成功了，但是第三步异步刷新缓存也有可能失败，那就会导致redis中的数据始终是旧数据，而数据库是新数据，造成数据不一致。【方案二解决】</li><li>并发：【方案三解决】 <ol><li>写写并发，如果两个线程现在都更新完了数据库，之后进行异步的刷新缓存，而异步操作是无法保证顺序的，所以存在刷新数据不准确的情况。那也会导致缓存和数据库数据不一致。</li><li>读写并发：<!----></li></ol></li></ol><!----><ol><li><!----></li><li><!----></li></ol><h3 id="方案二" tabindex="-1"><a class="header-anchor" href="#方案二" aria-hidden="true">#</a> <!----></h3><p>为了保证数据最终一致性，我们引入binlog，这样即使第三步刷新失败，也能通过binlog来进行日志回放，然后再刷新缓存。</p><p>写流程：先删除缓存，再更新DB，监听从库的binlog，通过binlog解析出需要刷新的数据，然后把数据刷新到redis。但是这种方式和前面说的异步刷新到redis有什么区别吗？这样也有可能刷新不成功啊？如何保证呢？这样刷新如果刷新不成功是可以重试的，重试直到成功。但是之前那种方式，异步刷新如果不成功就不能重试了，因为在这个时间段内，可能有其他线程对数据库进行了修改，重试刷新回去的数据可能是旧数据。但是读取binlog是能够得到最新的数据库数据的，所以可以不断重试直到刷新缓存成功。</p><p>读流程：先读缓存，如果缓存没读到，则去读DB，然后异步将数据刷回缓存。</p><p>特点：</p><ol><li>如果异步刷新失败，可以进行binlog日志回放，重试刷新。</li><li>也就是说无论删除缓存是否成功，后续的刷新缓存都是有保障的。</li></ol><p>缺点是并发安全没法保障，也是方案一中的并发问题，并发问题其实是读数据库和写缓存的操作不一致造成的，那么下面的方案三可以解决并发问题。</p><h3 id="方案三" tabindex="-1"><a class="header-anchor" href="#方案三" aria-hidden="true">#</a> 方案三</h3><p>写流程：先删除缓存，删除以后更新DB，监听从库的binlog，通过binlog解析出需要刷新的数据，然后把数据写入MQ，接下来消费者消费MQ把数据刷新到缓存。</p><p>读流程：先读缓存，如果没读到，就去读DB，然后异步的把数据写入MQ，消费者消费MQ获取数据写入缓存。</p><p>容灾分析：</p><p>写：如果删除缓存失败，那么由MQ保证缓存数据刷新。如果写入MQ失败，由重试获取binlog数据保证成功。如果消费MQ失败，重新消费即可。</p><p>读：如果异步写MQ失败，没关系，缓存是空的，其他来的读数据库就行。</p><p>并发分析：</p><p>这个方案通过MQ的介入，让读数据库+刷新缓存的操作串行化，这样就不存在读和刷新缓存顺序不一致导致的并发问题进而导致数据库和缓存数据不一致的情况了。</p><h2 id="缓存穿透、雪崩、击穿" tabindex="-1"><a class="header-anchor" href="#缓存穿透、雪崩、击穿" aria-hidden="true">#</a> 缓存穿透、雪崩、击穿</h2><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22839467/1672576549582-67c81a8c-a816-4358-9dda-08584c9833d7.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/22839467/1672576701844-8666de64-1747-4517-a3db-9e371b31bebe.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><!----><h3 id="缓存穿透" tabindex="-1"><a class="header-anchor" href="#缓存穿透" aria-hidden="true">#</a> 缓存穿透</h3><p>访问的数据在缓存和数据中都不存在，请求直达数据库。</p><p>解决：缓存空对象--&gt;额外内存消耗(设置ttl)，短期数据不一致(ttl短)</p><p>布隆过滤(bitmap实现)：先找布隆过滤，看看要查的数据存不存在，存在-&gt;redis-&gt;数据库</p><h3 id="缓存雪崩" tabindex="-1"><a class="header-anchor" href="#缓存雪崩" aria-hidden="true">#</a> 缓存雪崩</h3><p>我们为了保证数据库和缓存中数据一致性，会为redis的key设置过期时间，如果过期时间相同，可能会导致大量key同时失效，或者redis服务器宕机，大量请求直达数据库。</p><p>【我第一个项目中验证码的存储设置了60秒的过期时间。登录设置一个30分钟的key过期时间，在每次拦截时除了要获取用户的信息，还刷新这个key的生存时间，那么效果就是如果30分钟都没有访问这个网站，那么下次访问的时候就需要重新登录了，如果在30分钟内访问了网站，会保证不掉线。】</p><h4 id="解决" tabindex="-1"><a class="header-anchor" href="#解决" aria-hidden="true">#</a> 解决</h4><ol><li>给不同key添加ttl随机值，那么缓存失效时间就不同了。</li><li>Redis集群（哨兵）</li><li>多级缓存</li><li>缓存业务添加降级限流策略</li></ol><p>令牌桶算法：限流。</p><ol><li>请求在处理之前会拿到一个令牌。</li><li>根据限流的大小，按照一定的速率往桶里添加令牌。</li><li>桶设置最大令牌数，超过了就不允许新添加令牌。</li><li>只有拿到令牌的请求才能处理业务逻辑。</li></ol><h3 id="缓存击穿" tabindex="-1"><a class="header-anchor" href="#缓存击穿" aria-hidden="true">#</a> 缓存击穿</h3><!---->访问并且<!---->的key失效了，大量请求在瞬间给数据库带来大量冲击。（可能是这种场景：线程1访问缓存未命中，会进行缓存重建，缓存还没有重建完，期间线程2访问也未命中，也会重建...，如果两个线程并发访问可能会产生问题）<h4 id="解决-1" tabindex="-1"><a class="header-anchor" href="#解决-1" aria-hidden="true">#</a> 解决</h4><ol><li>yzx使用互斥锁，分布式环境下采用分布式锁，使用setnx设置一个状态位，表示是一种锁定状态，同一时间只有一个业务线程请求，其他线程需要等待，过程：（重试{未命中，加锁}）能够保证一致性，可能会产生死锁。</li><li>kyx逻辑过期：不设置ttl。不保证一致性。如果一个线程查询到数据发现过期了，那么尝试获取锁，如果获取到锁了，那么新开一个线程去做缓存重建的工作，然后把逻辑过期的旧数据返回。这样另外一个线程在缓存重建未成功时进去了，也发现过期了，那么他也尝试获取锁，不过没获取到，那么它就知道有其他线程在做缓存重建的工作，那么它也是直接把旧数据返回。它不能保证数据的一致性，但是能保证可用性。</li></ol><h4 id="分布式锁" tabindex="-1"><a class="header-anchor" href="#分布式锁" aria-hidden="true">#</a> 分布式锁</h4><h5 id="场景-5" tabindex="-1"><a class="header-anchor" href="#场景-5" aria-hidden="true">#</a> <!----></h5><!----><!----><!----><!----><!----><h5 id="加锁方式" tabindex="-1"><a class="header-anchor" href="#加锁方式" aria-hidden="true">#</a> <!----></h5><!----><!----><h5 id="解锁" tabindex="-1"><a class="header-anchor" href="#解锁" aria-hidden="true">#</a> <!----></h5><p>解锁时要判断unique_value是否是当前的客户端，如果是，才能删除，所以需要Lua脚本来保证解锁的原子性。</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token operator">//</span> 释放锁时，先比较 unique_value 是否相等，避免锁的误释放
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;del&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!----><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisClient</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 存redis带过期时间</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">cunWithGqtime</span><span class="token punctuation">(</span><span class="token class-name">String</span> keypreix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">R</span> r<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keypreix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 存redis逻辑过期时间</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">cunWithLjtime</span><span class="token punctuation">(</span><span class="token class-name">String</span> keypreix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">R</span> r<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keypreix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 缓存穿透</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">huancunchuantou</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> keypreix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> rClass<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从redis获取商铺信息</span>
        <span class="token class-name">String</span> r <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keypreix <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果不为空返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> rClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果从缓存中获取到了&quot;&quot;值，代表访问到了空缓存，不访问数据库.</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果为null从数据库中查询</span>
        <span class="token class-name">R</span> r1 <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// redis缓存空值,避免缓存穿透</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>keypreix<span class="token operator">+</span>id<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 存入redis</span>
        <span class="token function">cunWithGqtime</span><span class="token punctuation">(</span>keypreix<span class="token punctuation">,</span> id<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span>  <span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">huancunjichuanluojiguoqi</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> keypreix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从redis获取商铺信息</span>
        <span class="token class-name">String</span> rstring <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keypreix <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果为空返回空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>rstring<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 因为热点数据默认缓存里都有，如果没有说明数据库里应该也没有</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不为空，判断expiretime是否过期</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>rstring<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span> r1 <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果没过期直接返回</span>
            <span class="token keyword">return</span> r1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果过期了,看是否能获取锁</span>
        <span class="token keyword">boolean</span> b1 <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果获取不到锁,把旧的返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果能获取锁,开一个线程去重建redis</span>
            <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">R</span> r2 <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cunWithLjtime</span><span class="token punctuation">(</span>keypreix<span class="token punctuation">,</span> id<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 重建还是没获取到锁都返回旧的值</span>
        <span class="token keyword">return</span> r1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> aBoolean <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token constant">LOCK_SHOP_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>aBoolean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="全局唯一id" tabindex="-1"><a class="header-anchor" href="#全局唯一id" aria-hidden="true">#</a> 全局唯一id</h5><p>UUID</p><p>数据库自增id</p><p>雪花算法：64位，最高位代表正负，41位时间戳，10位计算机id，12位id序列号。</p><p>百度uidgenerator</p><p>美团leaf</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 全局唯一id</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">BEGIN_TIMESTAMP</span> <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 获取全局自增id
 * keyPreix: 不同的业务选择不同的key前缀
 */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getIncId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPreix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 时间戳</span>
    <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> timeStamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> <span class="token constant">BEGIN_TIMESTAMP</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据key和日期的一个redis自增数字</span>
    <span class="token class-name">String</span> yyyyMMdd <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> num <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;inc:&quot;</span><span class="token operator">+</span>keyPreix<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>yyyyMMdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> timeStamp <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!----><h1 id="redis实战" tabindex="-1"><a class="header-anchor" href="#redis实战" aria-hidden="true">#</a> redis实战</h1><h2 id="redis实现延迟队列" tabindex="-1"><a class="header-anchor" href="#redis实现延迟队列" aria-hidden="true">#</a> redis实现延迟队列</h2><p>延迟队列就是把当前要做的事情，往后推迟一段时间再做。</p><h3 id="场景-6" tabindex="-1"><a class="header-anchor" href="#场景-6" aria-hidden="true">#</a> 场景</h3><ol><li>购物平台下单，超过一定时间未付款，订单会自动取消。</li><li>打车的时候规定时间没有车主接单，平台会取消订单并提示暂时没有车主接单。</li><li>点外卖的时候如果5分钟不接单，就自动取消订单。</li></ol><h3 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h3><p>使用zset有序集合的方式实现延迟消息队列，zset的score存储延迟执行的时间。</p><p>使用zadd score1 value1命令往内存中生产消息，然后利用zrangebyscore找到符合条件的待处理任务。</p><h2 id="redis大key如何处理" tabindex="-1"><a class="header-anchor" href="#redis大key如何处理" aria-hidden="true">#</a> redis大key如何处理</h2><p>一般来说如果String类型的值大于10KB，或者hash、list、set、zset的元素个数超过5000个就是大key。</p><h3 id="获取大key" tabindex="-1"><a class="header-anchor" href="#获取大key" aria-hidden="true">#</a> 获取大key</h3><ol><li>可以通过redis-cli --bigkeys命令查找大key，最好在从接单执行。</li><li>使用scan命令对数据库扫描，然后用TYPE命令获取返回每一个key的类型。对String类型，用STRLEN命令获取字符串长度。对于集合类，可以从业务层获取平均元素大小。获取集合长度List:LLEN,Hash:HLEN,Set:SCARD,SortedSet:ZCARD。然后用集合长度乘以元素大小获取集合占用的内存。如果不能知道每个元素大小，可以使用MEMORY USAGE命令，查询一个键值对占用的内存空间。</li></ol><h3 id="删除大key" tabindex="-1"><a class="header-anchor" href="#删除大key" aria-hidden="true">#</a> 删除大key</h3><p>删除本质就是释放键值对占用的内存。释放内存是把空闲内存插入一个空闲内存的链表，方便后续的管理和再分配。这个过程本身需要时间，而且操作链表也耗费时间。所以一下子释放大量的内存，可能会造成redis主线程阻塞，导致其他请求的超时，超时越来越多，造成redis连接耗尽，产生各种异常。</p><p>我们采用分批次删除的方式。</p><ol><li>对于hash，使用hscan扫描法。</li><li>对于set，采用srandmember每次随机取数据删除。</li><li>对于zset，使用zremrangebyrank命令直接删除。</li><li>对于list，直接pop。</li></ol><p>也可以采用一步删除，用unlink命令放入一个异步线程进行删除不会阻塞主线程。</p><h2 id="redis管道有什么用" tabindex="-1"><a class="header-anchor" href="#redis管道有什么用" aria-hidden="true">#</a> redis管道有什么用？</h2><p>管道是客户端提供的一种批处理技术，用于一次处理多个redis命令，从而提高整个交互的性能。普通的模式是客户端发送一个命令，redis处理结果返回客户端，客户端再发送一个命令，redis返回结果。管道模式是客户端发送多个命令，然后redis处理命令并返回多个结果给客户端。提高整个系统的交互能力，减少网络等待的时间。</p><h2 id="redis事务支持回滚吗" tabindex="-1"><a class="header-anchor" href="#redis事务支持回滚吗" aria-hidden="true">#</a> redis事务支持回滚吗</h2><p>mysql是支持回滚的，当事务执行发生错误的时候，事务中的操作会回滚到事务执行前的状态。</p><p>redis中并没有提供回滚机制，discard命令是主动放弃事务的执行，把暂存的命令队列清空，但不会回滚。</p><p>不支持回滚的原因：因为事务执行时，一般错误是编程错误造成的，在生产环境中很少出现，所以没有必要开发事务回滚功能。第二就是事务回滚复杂和redis追求的简单高效设计主旨不符合。</p><h2 id="如何实现分布式锁" tabindex="-1"><a class="header-anchor" href="#如何实现分布式锁" aria-hidden="true">#</a> 如何实现分布式锁？</h2></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/fuzhengwei/xfg-resume-blog/edit/main/src/tech/database/redis1.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: tianxinyang@192.168.1.8">田鑫洋</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="MYSQL" class="vp-link nav-link prev nav-link prev" href="/tech/database/mysql.html"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>MYSQL</div></a><a aria-label="Redis(下)" class="vp-link nav-link next nav-link next" href="/tech/database/redis2.html"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Redis(下)<span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">txy</div><!----></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-76848ba1.js" defer></script>
  </body>
</html>
